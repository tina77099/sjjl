<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计分析 - 事件记录</title>
    <!-- 先加载Chart.js，确保其他脚本可以使用它 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- 测试Chart.js加载状态的脚本 -->
    <script>
        console.log('页面开始加载...');
        console.log('Chart.js初始加载状态:', typeof Chart !== 'undefined' ? '已加载' : '未加载');
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM内容已加载');
            console.log('Chart.js DOMContentLoaded时状态:', typeof Chart !== 'undefined' ? '已加载' : '未加载');
            
            // 如果Chart未加载，尝试使用备用CDN
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js未加载，尝试使用备用CDN...');
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.onload = function() {
                    console.log('Chart.js从备用CDN加载成功');
                    // 手动初始化图表
                    if (typeof initStatisticsPage === 'function') {
                        initStatisticsPage();
                    }
                };
                document.head.appendChild(script);
            }
        });
        
        window.addEventListener('load', function() {
            console.log('页面完全加载');
            console.log('Chart.js load事件时状态:', typeof Chart !== 'undefined' ? '已加载' : '未加载');
            
            // 测试创建简单图表
            setTimeout(function() {
                try {
                    console.log('尝试创建测试图表...');
                    const testCanvas = document.createElement('canvas');
                    testCanvas.id = 'testChart';
                    testCanvas.width = 100;
                    testCanvas.height = 100;
                    testCanvas.style.display = 'none';
                    document.body.appendChild(testCanvas);
                    
                    const ctx = testCanvas.getContext('2d');
                    if (ctx && typeof Chart !== 'undefined') {
                        const testChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['测试'],
                                datasets: [{
                                    label: '测试数据',
                                    data: [5],
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)'
                                }]
                            }
                        });
                        console.log('测试图表创建成功:', testChart);
                    } else {
                        console.error('无法创建测试图表，Canvas上下文或Chart不可用');
                    }
                } catch (e) {
                    console.error('创建测试图表时出错:', e);
                }
            }, 1000);
        });
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 备用Chart.js CDN，如果主要CDN失败时使用 -->
    <script>
        // 检查Chart是否已加载，如果未加载，则从备用CDN加载
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js未能从主要CDN加载，尝试备用CDN...');
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.onload = function() {
                    console.log('Chart.js从备用CDN加载成功');
                    // 重新初始化图表
                    if (typeof initStatisticsPage === 'function') {
                        initStatisticsPage();
                    }
                };
                script.onerror = function() {
                    console.error('两个CDN都无法加载Chart.js，将显示替代内容');
                    // 显示所有图表容器的替代内容
                    document.querySelectorAll('.h-64').forEach(function(container) {
                        var parent = container.closest('.bg-white');
                        if (parent) {
                            var title = parent.querySelector('h3') ? parent.querySelector('h3').textContent : '图表';
                            container.innerHTML = `
                                <div class="flex items-center justify-center h-full flex-col">
                                    <i class="fas fa-chart-pie text-gray-300 text-5xl mb-3"></i>
                                    <p class="text-gray-500">无法加载${title}，请刷新页面重试</p>
                                </div>
                            `;
                        }
                    });
                };
                document.head.appendChild(script);
            }
        });
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 侧边栏 -->
    <div class="flex h-screen overflow-hidden">
        <div class="w-64 bg-white shadow-md hidden md:block">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-indigo-600">事件记录</h1>
                <p class="text-gray-500 text-sm">记录生活，追踪成长</p>
            </div>
            <nav class="mt-6">
                <ul>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="index.html" class="flex items-center">
                            <i class="fas fa-home mr-3"></i>
                            <span>仪表盘</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="calendar.html" class="flex items-center">
                            <i class="fas fa-calendar-alt mr-3"></i>
                            <span>日历视图</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="events.html" class="flex items-center">
                            <i class="fas fa-list mr-3"></i>
                            <span>事件列表</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 bg-indigo-50 text-indigo-600 font-medium">
                        <a href="statistics.html" class="flex items-center">
                            <i class="fas fa-chart-pie mr-3"></i>
                            <span>统计分析</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="tags.html" class="flex items-center">
                            <i class="fas fa-tag mr-3"></i>
                            <span>标签管理</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="settings.html" class="flex items-center">
                            <i class="fas fa-cog mr-3"></i>
                            <span>设置</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 overflow-auto">
            <!-- 顶部导航栏 - 替换为组件容器 -->
            <div id="header-container">
                <!-- 备用头部组件，在加载失败时显示 -->
                <header class="bg-white shadow-sm">
                    <div class="flex items-center justify-between p-4">
                        <button class="md:hidden text-gray-600">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <div class="flex items-center">
                            <div class="relative">
                                <input type="text" placeholder="搜索事件..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 w-64">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <div class="ml-4 flex space-x-2">
                                <button id="btn-new-plan" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center">
                                    <i class="fas fa-calendar-plus mr-2"></i>新建计划
                                </button>
                                <button id="btn-new-record" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors inline-flex items-center">
                                    <i class="fas fa-bookmark mr-2"></i>记录事项
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <a href="settings.html#profile-section" class="h-8 w-8 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-600 font-medium hover:bg-indigo-300 transition-colors cursor-pointer" title="个人设置">
                                <i class="fas fa-user-circle"></i>
                            </a>
                        </div>
                    </div>
                </header>
            </div>

            <!-- 统计分析内容 -->
            <main class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">统计分析</h2>
                    <div class="flex items-center">
                        <button id="refresh-charts" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors mr-3">
                            <i class="fas fa-sync-alt mr-2"></i>刷新图表
                        </button>
                        <select class="px-3 py-2 border rounded-lg bg-white mr-3">
                            <option value="week">本周</option>
                            <option value="month" selected>本月</option>
                            <option value="quarter">本季度</option>
                            <option value="year">本年</option>
                            <option value="custom">自定义</option>
                        </select>
                        <button class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors">
                            <i class="fas fa-download mr-2"></i>导出报告
                        </button>
                    </div>
                </div>
                
                <!-- 概览卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="bg-indigo-100 p-3 rounded-full">
                                <i class="fas fa-calendar-check text-indigo-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-gray-500 text-sm">总事件数</h3>
                                <p class="text-2xl font-bold">42</p>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-sm">
                            <span class="text-green-600 font-medium">↑ 12%</span>
                            <span class="text-gray-500 ml-2">较上月</span>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-check-circle text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-gray-500 text-sm">已完成</h3>
                                <p class="text-2xl font-bold">35</p>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-sm">
                            <span class="text-green-600 font-medium">↑ 8%</span>
                            <span class="text-gray-500 ml-2">较上月</span>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-clock text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-gray-500 text-sm">进行中</h3>
                                <p class="text-2xl font-bold">5</p>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-sm">
                            <span class="text-red-600 font-medium">↓ 3%</span>
                            <span class="text-gray-500 ml-2">较上月</span>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i class="fas fa-chart-line text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-gray-500 text-sm">完成率</h3>
                                <p class="text-2xl font-bold">83%</p>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-sm">
                            <span class="text-green-600 font-medium">↑ 5%</span>
                            <span class="text-gray-500 ml-2">较上月</span>
                        </div>
                    </div>
                </div>
                
                <!-- 图表区域 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- 事件分类统计 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-800">事件分类统计</h3>
                        </div>
                        <div class="p-6">
                            <div class="h-64">
                                <canvas id="categoryChart"></canvas>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-6">
                                <!-- 图例将由JavaScript动态生成，已调整为两行布局 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 每日事件数量趋势 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-800">每日事件数量趋势</h3>
                        </div>
                        <div class="p-6">
                            <div class="h-64">
                                <canvas id="trendChart"></canvas>
                            </div>
                            <div class="mt-6">
                                <p class="text-sm text-gray-600">本月事件总数比上月增长了 <span class="text-green-600 font-medium">12%</span>，平均每日完成事件 <span class="font-medium">3.5</span> 个。</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 时间分配和完成率 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- 时间分配 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-800">时间分配</h3>
                        </div>
                        <div class="p-6">
                            <div class="h-64">
                                <canvas id="timeAllocationChart"></canvas>
                            </div>
                            <div class="mt-6">
                                <p class="text-sm text-gray-600"><!-- 时间分配描述将由JavaScript动态生成 --></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 每周完成率 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-800">每周完成率</h3>
                        </div>
                        <div class="p-6">
                            <div class="h-64">
                                <canvas id="completionRateChart"></canvas>
                            </div>
                            <div class="mt-6">
                                <p class="text-sm text-gray-600">本月第三周完成率最高，达到 <span class="font-medium">92%</span>。整体趋势呈上升状态，表现良好。</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 热门标签和时段分析 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 热门标签 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-800">热门标签</h3>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap gap-2">
                                <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm">学习成长 (5)</span>
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">体验突破 (3)</span>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">休闲放松 (3)</span>
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">工作职业 (2)</span>
                                <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">家庭生活 (1)</span>
                                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">人际社群 (1)</span>
                            </div>
                            <div class="mt-6">
                                <h4 class="font-medium text-gray-700 mb-3">标签使用趋势</h4>
                                <div class="h-40">
                                    <canvas id="tagTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 高效时段分析 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-800">高效时段分析</h3>
                            <p class="text-xs text-indigo-600 mt-1">时段标签已更新，更加清晰直观</p>
                        </div>
                        <div class="p-6">
                            <div class="h-64">
                                <canvas id="timeEfficiencyChart"></canvas>
                            </div>
                            <div class="mt-6">
                                <h4 class="font-medium text-gray-700 mb-2">高效时段建议</h4>
                                <ul class="space-y-2 text-sm text-gray-600">
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>9-12点(上午)是您的黄金工作时段，建议安排重要任务</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>15-18点(傍晚)适合创意和协作工作</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>21-24点(深夜)效率明显下降，建议安排轻松活动</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 新建事件弹窗 -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" id="newEventModal">
        <div class="bg-white rounded-lg w-full max-w-md mx-4">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">新建事件</h3>
                    <button class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="eventTitle">
                            事件标题
                        </label>
                        <input type="text" id="eventTitle" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="输入事件标题">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="startDate">
                                开始时间
                            </label>
                            <input type="datetime-local" id="startDate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="endDate">
                                结束时间
                            </label>
                            <input type="datetime-local" id="endDate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="eventCategory">
                            事件分类
                        </label>
                        <select id="eventCategory" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300">
                            <option value="work">工作</option>
                            <option value="project">项目</option>
                            <option value="study">学习</option>
                            <option value="health">健康</option>
                            <option value="life">生活</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="eventLocation">
                            地点
                        </label>
                        <input type="text" id="eventLocation" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="输入事件地点">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="eventTags">
                            标签
                        </label>
                        <input type="text" id="eventTags" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="输入标签，用逗号分隔">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="eventDescription">
                            事件描述
                        </label>
                        <textarea id="eventDescription" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="输入事件描述"></textarea>
                    </div>
                    
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="setReminder" class="h-4 w-4 text-indigo-600 rounded">
                        <label for="setReminder" class="ml-2 text-gray-700 text-sm">
                            设置提醒
                        </label>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" class="px-4 py-2 text-gray-700 mr-2">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 简单的交互逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 移动端侧边栏切换
            const menuBtn = document.querySelector('button.md\\:hidden');
            const sidebar = document.querySelector('.w-64');
            
            menuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('hidden');
            });
            
            // 弹出窗口功能
            const planModal = document.getElementById('modal-new-plan');
            const recordModal = document.getElementById('modal-new-record');
            
            // 打开弹出窗口
            document.getElementById('btn-new-plan').addEventListener('click', function() {
                planModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // 防止背景滚动
            });
            
            document.getElementById('btn-new-record').addEventListener('click', function() {
                recordModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
            
            // 关闭弹出窗口
            document.getElementById('close-plan-modal').addEventListener('click', function() {
                planModal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            document.getElementById('cancel-plan-btn').addEventListener('click', function() {
                planModal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            document.getElementById('close-record-modal').addEventListener('click', function() {
                recordModal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            document.getElementById('cancel-record-btn').addEventListener('click', function() {
                recordModal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            // 点击模态窗口外部关闭
            planModal.addEventListener('click', function(e) {
                if (e.target === planModal) {
                    planModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
            
            recordModal.addEventListener('click', function(e) {
                if (e.target === recordModal) {
                    recordModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
            
            // 设置今天的日期
            const today = new Date();
            const formattedDate = today.toISOString().substring(0, 10);
            document.getElementById('plan-due-date').value = formattedDate;
            document.getElementById('record-date').value = formattedDate;
            
            // 设置当前时间
            const hours = today.getHours().toString().padStart(2, '0');
            const minutes = today.getMinutes().toString().padStart(2, '0');
            document.getElementById('record-time').value = `${hours}:${minutes}`;
            
            // 初始化表单提交处理
            const newPlanForm = document.getElementById('new-plan-form');
            if (newPlanForm) {
                newPlanForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const planTitle = document.getElementById('plan-title').value;
                    const planDesc = document.getElementById('plan-desc').value;
                    const planDueDate = document.getElementById('plan-due-date').value;
                    const planTypeEl = document.querySelector('input[name="plan-type"]:checked');
                    const planPriorityEl = document.querySelector('input[name="priority"]:checked');
                    
                    if (!planTypeEl || !planPriorityEl) {
                        alert('请选择计划类型和优先级');
                        return;
                    }
                    
                    const planType = planTypeEl.value;
                    const planPriority = planPriorityEl.value;
                    
                    // 创建计划对象
                    const newPlan = {
                        id: 'plan_' + Date.now(),
                        title: planTitle,
                        description: planDesc,
                        eventType: 'plan',
                        startTime: new Date(planDueDate).toISOString(),
                        dueDate: new Date(planDueDate).toISOString(),
                        isAllDay: true,
                        category: planType,
                        priority: planPriority,
                        status: 'pending',
                        tags: [planType],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // 保存事件到localStorage
                    saveEvent(newPlan);
                    
                    // 重置表单并关闭模态框
                    this.reset();
                    planModal.classList.add('hidden');
                    document.body.style.overflow = '';
                    
                    // 显示成功提示
                    alert('计划已成功保存！');
                });
            }
            
            const newRecordForm = document.getElementById('new-record-form');
            if (newRecordForm) {
                newRecordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const recordTitle = document.getElementById('record-title').value.trim();
                    const recordDesc = document.getElementById('record-desc').value.trim();
                    const recordDate = document.getElementById('record-date').value;
                    const recordTime = document.getElementById('record-time') ? document.getElementById('record-time').value : '00:00';
                    const recordTypeEl = document.querySelector('input[name="record-type"]:checked');
                    
                    if (!recordTypeEl) {
                        alert('请选择记录类型');
                        return;
                    }
                    
                    const recordType = recordTypeEl.value;
                    
                    // 组合日期和时间
                    const dateTimeStr = `${recordDate}T${recordTime}`;
                    
                    // 创建记录对象
                    const newRecord = {
                        id: 'record_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        title: recordTitle || '(无标题记录)',
                        description: recordDesc,
                        eventType: 'record',
                        startTime: new Date(dateTimeStr).toISOString(),
                        isAllDay: false,
                        category: recordType,
                        tags: [recordType],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // 保存事件到localStorage
                    saveEvent(newRecord);
                    
                    // 重置表单并关闭模态框
                    this.reset();
                    recordModal.classList.add('hidden');
                    document.body.style.overflow = '';
                    
                    // 显示成功提示
                    alert('记录已成功保存！');
                });
            }
            
            // 保存事件到localStorage
            function saveEvent(event) {
                // 获取现有事件列表
                const events = JSON.parse(localStorage.getItem('events') || '[]');
                
                // 添加新事件
                events.push(event);
                
                // 保存回localStorage
                localStorage.setItem('events', JSON.stringify(events));
                
                // 如果有刷新图表函数，调用它
                if (typeof handleRefreshCharts === 'function') {
                    setTimeout(handleRefreshCharts, 500);
                }
                
                return true;
            }
            
            // 确保表单处理程序初始化
            if (typeof initializeFormHandlers === 'function') {
                initializeFormHandlers();
                console.log('已初始化表单处理程序');
            } else {
                console.error('未找到initializeFormHandlers函数');
            }
        });
    </script>

    <!-- 添加自定义样式 -->
    <style>
        .animate-pulse-light {
            animation: pulse-light 1.5s infinite;
        }
        
        @keyframes pulse-light {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 图表悬停效果 */
        canvas {
            transition: all 0.3s ease;
        }
        
        canvas:hover {
            transform: scale(1.02);
        }
    </style>
    
    <!-- 引入组件和公共JS文件 -->
    <script src="js/components.js"></script>
    <script src="js/common.js"></script>
    <script src="js/statistics.js"></script>
    
    <!-- 添加调试脚本 -->
    <script>
        // 调试脚本 - 检查图表初始化情况
        document.addEventListener('DOMContentLoaded', function() {
            console.log('正在检查图表初始化...');
            setTimeout(function() {
                const charts = [
                    { id: 'categoryChart', instance: window.categoryChart },
                    { id: 'trendChart', instance: window.trendChart },
                    { id: 'timeAllocationChart', instance: window.timeAllocationChart },
                    { id: 'completionRateChart', instance: window.completionRateChart },
                    { id: 'tagTrendChart', instance: window.tagTrendChart },
                    { id: 'timeEfficiencyChart', instance: window.timeEfficiencyChart }
                ];
                
                charts.forEach(chart => {
                    const element = document.getElementById(chart.id);
                    console.log(`检查图表 ${chart.id}:`);
                    console.log(`- DOM元素存在: ${element ? '是' : '否'}`);
                    console.log(`- 图表实例存在: ${chart.instance ? '是' : '否'}`);
                });
            }, 1000);
        });
    </script>

<!-- 添加弹出框HTML代码 -->
    
<!-- 弹出窗口 - 新建计划 -->
<div id="modal-new-plan" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-2xl font-bold text-gray-800">新建计划</h2>
            <button id="close-plan-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="new-plan-form">
                <!-- 计划标题 -->
                <div class="mb-4">
                    <label for="plan-title" class="block text-gray-700 font-medium mb-2">计划标题</label>
                    <input type="text" id="plan-title" name="title" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" 
                        placeholder="输入计划名称" required>
                </div>

                <!-- 计划类型 -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">计划类型</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-work" class="mr-2" value="work" checked>
                            <label for="type-work" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                工作职业
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-study" class="mr-2" value="study">
                            <label for="type-study" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                学习成长
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-exp" class="mr-2" value="experience">
                            <label for="type-exp" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                                体验突破
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-leisure" class="mr-2" value="leisure">
                            <label for="type-leisure" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                休闲放松
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-family" class="mr-2" value="family">
                            <label for="type-family" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                家庭生活
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-social" class="mr-2" value="social">
                            <label for="type-social" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></span>
                                人际社群
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 计划描述 -->
                <div class="mb-4">
                    <label for="plan-desc" class="block text-gray-700 font-medium mb-2">计划详情描述</label>
                    <textarea id="plan-desc" name="description" rows="3" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" 
                        placeholder="输入计划的详细描述"></textarea>
                </div>

                <!-- 截止日期 -->
                <div class="mb-4">
                    <label for="plan-due-date" class="block text-gray-700 font-medium mb-2">截止日期</label>
                    <input type="date" id="plan-due-date" name="due-date" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" required>
                </div>

                <!-- 优先级 -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">优先级</label>
                    <div class="flex space-x-4">
                        <div class="flex items-center">
                            <input type="radio" name="priority" id="priority-low" class="mr-2" value="low">
                            <label for="priority-low" class="text-green-600">低</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="priority" id="priority-medium" class="mr-2" value="medium" checked>
                            <label for="priority-medium" class="text-yellow-600">中</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="priority" id="priority-high" class="mr-2" value="high">
                            <label for="priority-high" class="text-red-600">高</label>
                        </div>
                    </div>
                </div>
                
                <!-- 按钮 -->
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-plan-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        保存计划
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 弹出窗口 - 记录事项 -->
<div id="modal-new-record" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-2xl font-bold text-gray-800">记录事项</h2>
            <button id="close-record-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="new-record-form">
                <!-- 事项标题 -->
                <div class="mb-4">
                    <label for="record-title" class="block text-gray-700 font-medium mb-2">事项标题</label>
                    <input type="text" id="record-title" name="title" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" 
                        placeholder="输入事项名称" required>
                </div>

                <!-- 事项分类 -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">事项分类</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-study" class="mr-2" value="study" checked>
                            <label for="rec-type-study" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                学习成长
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-exp" class="mr-2" value="experience">
                            <label for="rec-type-exp" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                                体验突破
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-leisure" class="mr-2" value="leisure">
                            <label for="rec-type-leisure" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                休闲放松
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-family" class="mr-2" value="family">
                            <label for="rec-type-family" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                家庭生活
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-work" class="mr-2" value="work">
                            <label for="rec-type-work" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                工作职业
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-social" class="mr-2" value="social">
                            <label for="rec-type-social" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></span>
                                人际社群
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 完成日期 -->
                <div class="mb-4">
                    <label for="record-date" class="block text-gray-700 font-medium mb-2">完成日期</label>
                    <input type="date" id="record-date" name="completion-date" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" required>
                </div>

                <!-- 完成时间 -->
                <div class="mb-4">
                    <label for="record-time" class="block text-gray-700 font-medium mb-2">完成时间</label>
                    <input type="time" id="record-time" name="completion-time" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" required>
                </div>

                <!-- 事项描述 -->
                <div class="mb-4">
                    <label for="record-desc" class="block text-gray-700 font-medium mb-2">事项详情</label>
                    <textarea id="record-desc" name="description" rows="3" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" 
                        placeholder="输入事项的详细描述或感想"></textarea>
                </div>

                <!-- 标签 -->
                <div class="mb-6">
                    <label for="record-tags" class="block text-gray-700 font-medium mb-2">添加标签</label>
                    <div class="flex flex-wrap items-center border rounded-lg p-2">
                        <input type="text" id="record-tags" 
                            class="flex-1 px-3 py-1 focus:outline-none" 
                            placeholder="输入标签并按回车添加">
                    </div>
                    <div class="flex flex-wrap mt-2" id="tags-container">
                        <!-- 标签将在这里动态显示 -->
                    </div>
                    <input type="hidden" id="tags-hidden" name="tags" value="">
                </div>
                
                <!-- 按钮 -->
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-record-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        保存记录
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 添加自动测试脚本 -->
<script>
    window.addEventListener('load', function() {
        // 等待一秒后执行测试，确保页面完全加载
        setTimeout(function() {
            console.log('执行自动测试...');
            
            // 检查Chart.js是否加载
            if (typeof Chart === 'undefined') {
                console.error('Chart.js未加载，尝试手动加载');
                
                var script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
                script.onload = function() {
                    console.log('Chart.js手动加载成功，重新初始化图表');
                    if (typeof initStatisticsPage === 'function') {
                        initStatisticsPage();
                    }
                };
                document.head.appendChild(script);
                return;
            }
            
            // 检查canvas元素
            const canvases = document.querySelectorAll('canvas');
            if (canvases.length === 0) {
                console.error('未找到canvas元素');
                return;
            }
            
            // 检查图表实例
            const chartInstances = [
                window.categoryChart,
                window.trendChart,
                window.timeAllocationChart,
                window.completionRateChart,
                window.tagTrendChart,
                window.timeEfficiencyChart
            ];
            
            // 统计已初始化的图表数量
            const initializedCharts = chartInstances.filter(chart => chart !== null && chart !== undefined).length;
            console.log(`已初始化图表: ${initializedCharts}/${chartInstances.length}`);
            
            // 如果图表实例数量不足，尝试刷新图表
            if (initializedCharts < chartInstances.length) {
                console.log('图表初始化不完整，尝试刷新...');
                
                // 如果有刷新按钮，点击它
                const refreshBtn = document.getElementById('refresh-charts');
                if (refreshBtn) {
                    console.log('点击刷新按钮');
                    refreshBtn.click();
                } else if (typeof handleRefreshCharts === 'function') {
                    // 否则直接调用刷新函数
                    console.log('调用刷新函数');
                    handleRefreshCharts();
                }
            }
        }, 1000);
    });
</script>
</body>
</html>