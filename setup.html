<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮箱配置向导 - 事件记录系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center">
                <i class="fas fa-envelope-open-text text-2xl text-indigo-600 mr-3"></i>
                <h1 class="text-2xl font-bold text-gray-900">邮箱配置向导</h1>
            </div>
            <p class="text-gray-600 mt-1">配置SMTP邮箱设置，启用邮件验证功能</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-6 py-8">
        <!-- 步骤指示器 -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <div class="flex items-center">
                    <div class="flex items-center text-indigo-600">
                        <div class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center text-sm font-medium">
                            1
                        </div>
                        <span class="ml-2 text-sm font-medium">选择邮箱</span>
                    </div>
                    <div class="w-16 h-0.5 bg-gray-300 mx-4"></div>
                    <div class="flex items-center text-gray-400">
                        <div class="w-8 h-8 bg-gray-300 text-white rounded-full flex items-center justify-center text-sm font-medium">
                            2
                        </div>
                        <span class="ml-2 text-sm font-medium">配置设置</span>
                    </div>
                    <div class="w-16 h-0.5 bg-gray-300 mx-4"></div>
                    <div class="flex items-center text-gray-400">
                        <div class="w-8 h-8 bg-gray-300 text-white rounded-full flex items-center justify-center text-sm font-medium">
                            3
                        </div>
                        <span class="ml-2 text-sm font-medium">测试验证</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要内容 -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- 步骤1: 选择邮箱服务商 -->
            <div id="step1" class="p-8">
                <h2 class="text-xl font-bold text-gray-900 mb-6">选择您的邮箱服务商</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Gmail -->
                    <div class="provider-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer hover:border-indigo-500 transition-colors" data-provider="gmail">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center text-white text-xl">
                                <i class="fab fa-google"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="font-semibold text-gray-900">Gmail</h3>
                                <p class="text-sm text-gray-500">smtp.gmail.com:587</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">需要启用两步验证并生成应用专用密码</p>
                    </div>

                    <!-- QQ邮箱 -->
                    <div class="provider-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer hover:border-indigo-500 transition-colors" data-provider="qq">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center text-white text-xl">
                                <i class="fab fa-qq"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="font-semibold text-gray-900">QQ邮箱</h3>
                                <p class="text-sm text-gray-500">smtp.qq.com:587</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">需要在设置中开启SMTP服务并获取授权码</p>
                    </div>

                    <!-- 163邮箱 -->
                    <div class="provider-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer hover:border-indigo-500 transition-colors" data-provider="163">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center text-white text-xl">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="font-semibold text-gray-900">163邮箱</h3>
                                <p class="text-sm text-gray-500">smtp.163.com:25</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">需要在设置中开启SMTP服务并获取授权码</p>
                    </div>

                    <!-- Outlook -->
                    <div class="provider-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer hover:border-indigo-500 transition-colors" data-provider="outlook">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center text-white text-xl">
                                <i class="fab fa-microsoft"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="font-semibold text-gray-900">Outlook</h3>
                                <p class="text-sm text-gray-500">smtp-mail.outlook.com:587</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">使用Microsoft账户密码或应用专用密码</p>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button id="nextStep1" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一步 <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- 步骤2: 配置设置 -->
            <div id="step2" class="p-8 hidden">
                <h2 class="text-xl font-bold text-gray-900 mb-6">配置邮箱设置</h2>
                
                <!-- 选中的服务商信息 -->
                <div id="selectedProvider" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <!-- 动态内容 -->
                </div>

                <!-- 配置表单 -->
                <form id="configForm" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            邮箱地址 <span class="text-red-500">*</span>
                        </label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="your-email@gmail.com">
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                            应用专用密码 <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input type="password" id="password" name="password" required
                                   class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="应用专用密码或授权码">
                            <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">不是您的登录密码，而是专门为应用生成的密码</p>
                    </div>

                    <div>
                        <label for="fromName" class="block text-sm font-medium text-gray-700 mb-2">
                            发送方名称
                        </label>
                        <input type="text" id="fromName" name="fromName" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="事件记录系统" value="事件记录系统">
                    </div>
                </form>

                <!-- 设置指南 -->
                <div id="setupGuide" class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <!-- 动态内容 -->
                </div>

                <div class="mt-8 flex justify-between">
                    <button id="prevStep2" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> 上一步
                    </button>
                    <button id="nextStep2" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        下一步 <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- 步骤3: 测试验证 -->
            <div id="step3" class="p-8 hidden">
                <h2 class="text-xl font-bold text-gray-900 mb-6">测试邮件发送</h2>
                
                <div class="space-y-6">
                    <!-- 配置预览 -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-medium text-gray-900 mb-3">配置预览</h3>
                        <div id="configPreview" class="space-y-2 text-sm">
                            <!-- 动态内容 -->
                        </div>
                    </div>

                    <!-- 测试邮件 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-medium text-gray-900 mb-3">发送测试邮件</h3>
                        <div class="flex items-center space-x-4">
                            <input type="email" id="testEmail" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="输入测试邮箱地址">
                            <button id="sendTest" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-paper-plane mr-2"></i>发送测试
                            </button>
                        </div>
                    </div>

                    <!-- 测试结果 -->
                    <div id="testResult" class="hidden">
                        <!-- 动态内容 -->
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button id="prevStep3" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> 上一步
                    </button>
                    <div class="space-x-4">
                        <button id="saveConfig" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>保存配置
                        </button>
                        <button id="finishSetup" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-check mr-2"></i>完成设置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 帮助信息 -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-question-circle text-indigo-600 mr-2"></i>需要帮助？
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">常见问题</h4>
                    <ul class="space-y-1 text-gray-600">
                        <li>• 什么是应用专用密码？</li>
                        <li>• 如何开启SMTP服务？</li>
                        <li>• 为什么连接失败？</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">技术支持</h4>
                    <ul class="space-y-1 text-gray-600">
                        <li>• 查看详细文档：PHPMailer集成指南.md</li>
                        <li>• 检查错误日志：api/email.log</li>
                        <li>• 运行测试脚本：php api/test-email.php</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 邮箱服务商配置
        const providers = {
            gmail: {
                name: 'Gmail',
                host: 'smtp.gmail.com',
                port: 587,
                icon: 'fab fa-google',
                color: 'red',
                guide: `
                    <h4 class="font-medium text-yellow-800 mb-2">Gmail 设置步骤：</h4>
                    <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-700">
                        <li>登录 Google 账户，前往 <a href="https://myaccount.google.com/security" target="_blank" class="underline">安全设置</a></li>
                        <li>启用"两步验证"</li>
                        <li>在"应用专用密码"中生成新密码</li>
                        <li>将16位密码填入上方密码框</li>
                    </ol>
                `
            },
            qq: {
                name: 'QQ邮箱',
                host: 'smtp.qq.com',
                port: 587,
                icon: 'fab fa-qq',
                color: 'blue',
                guide: `
                    <h4 class="font-medium text-yellow-800 mb-2">QQ邮箱 设置步骤：</h4>
                    <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-700">
                        <li>登录 QQ邮箱，进入设置</li>
                        <li>账户 → POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务</li>
                        <li>开启"POP3/SMTP服务"</li>
                        <li>获取授权码并填入上方密码框</li>
                    </ol>
                `
            },
            '163': {
                name: '163邮箱',
                host: 'smtp.163.com',
                port: 25,
                icon: 'fas fa-envelope',
                color: 'green',
                guide: `
                    <h4 class="font-medium text-yellow-800 mb-2">163邮箱 设置步骤：</h4>
                    <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-700">
                        <li>登录 163邮箱，进入设置</li>
                        <li>POP3/SMTP/IMAP → 开启SMTP服务</li>
                        <li>获取授权码并填入上方密码框</li>
                        <li>注意：163邮箱使用25端口</li>
                    </ol>
                `
            },
            outlook: {
                name: 'Outlook',
                host: 'smtp-mail.outlook.com',
                port: 587,
                icon: 'fab fa-microsoft',
                color: 'blue',
                guide: `
                    <h4 class="font-medium text-yellow-800 mb-2">Outlook 设置步骤：</h4>
                    <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-700">
                        <li>使用Microsoft账户密码</li>
                        <li>或在安全设置中生成应用专用密码</li>
                        <li>确保账户启用了SMTP访问</li>
                    </ol>
                `
            }
        };

        let currentStep = 1;
        let selectedProvider = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initProviderSelection();
            initStepNavigation();
            initPasswordToggle();
            initTestFunctionality();
        });

        // 服务商选择
        function initProviderSelection() {
            document.querySelectorAll('.provider-card').forEach(card => {
                card.addEventListener('click', function() {
                    // 清除之前的选择
                    document.querySelectorAll('.provider-card').forEach(c => {
                        c.classList.remove('border-indigo-500', 'bg-indigo-50');
                    });
                    
                    // 选中当前卡片
                    this.classList.add('border-indigo-500', 'bg-indigo-50');
                    selectedProvider = this.dataset.provider;
                    
                    // 启用下一步按钮
                    document.getElementById('nextStep1').disabled = false;
                });
            });
        }

        // 步骤导航
        function initStepNavigation() {
            document.getElementById('nextStep1').addEventListener('click', () => goToStep(2));
            document.getElementById('prevStep2').addEventListener('click', () => goToStep(1));
            document.getElementById('nextStep2').addEventListener('click', () => goToStep(3));
            document.getElementById('prevStep3').addEventListener('click', () => goToStep(2));
        }

        function goToStep(step) {
            // 隐藏所有步骤
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }
            
            // 显示目标步骤
            document.getElementById(`step${step}`).classList.remove('hidden');
            currentStep = step;
            
            // 更新步骤指示器
            updateStepIndicator();
            
            // 步骤特定的处理
            if (step === 2) {
                setupStep2();
            } else if (step === 3) {
                setupStep3();
            }
        }

        function updateStepIndicator() {
            // 实现步骤指示器更新逻辑
            // 这里可以添加更复杂的视觉反馈
        }

        function setupStep2() {
            const provider = providers[selectedProvider];
            
            // 显示选中的服务商信息
            document.getElementById('selectedProvider').innerHTML = `
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-${provider.color}-500 rounded-lg flex items-center justify-center text-white mr-3">
                        <i class="${provider.icon}"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900">${provider.name}</h3>
                        <p class="text-sm text-gray-600">${provider.host}:${provider.port}</p>
                    </div>
                </div>
            `;
            
            // 显示设置指南
            document.getElementById('setupGuide').innerHTML = provider.guide;
        }

        function setupStep3() {
            const formData = new FormData(document.getElementById('configForm'));
            const provider = providers[selectedProvider];
            
            // 配置预览
            document.getElementById('configPreview').innerHTML = `
                <div><strong>服务商:</strong> ${provider.name}</div>
                <div><strong>SMTP服务器:</strong> ${provider.host}:${provider.port}</div>
                <div><strong>邮箱地址:</strong> ${formData.get('email')}</div>
                <div><strong>发送方名称:</strong> ${formData.get('fromName')}</div>
            `;
            
            // 自动填充测试邮箱
            document.getElementById('testEmail').value = formData.get('email');
        }

        // 密码显示切换
        function initPasswordToggle() {
            document.getElementById('togglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.className = 'fas fa-eye-slash text-gray-400 hover:text-gray-600';
                } else {
                    passwordInput.type = 'password';
                    icon.className = 'fas fa-eye text-gray-400 hover:text-gray-600';
                }
            });
        }

        // 测试功能
        function initTestFunctionality() {
            document.getElementById('sendTest').addEventListener('click', sendTestEmail);
            document.getElementById('saveConfig').addEventListener('click', saveConfiguration);
            document.getElementById('finishSetup').addEventListener('click', finishSetup);
        }

        async function sendTestEmail() {
            const testEmail = document.getElementById('testEmail').value;
            const button = document.getElementById('sendTest');
            
            if (!testEmail) {
                alert('请输入测试邮箱地址');
                return;
            }
            
            // 显示加载状态
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>发送中...';
            button.disabled = true;
            
            try {
                const response = await fetch('api/send-verification.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: testEmail,
                        type: 'register'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showTestResult(true, '测试邮件发送成功！请检查您的邮箱。');
                } else {
                    showTestResult(false, result.error || '发送失败');
                }
                
            } catch (error) {
                showTestResult(false, '网络错误：' + error.message);
            } finally {
                button.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>发送测试';
                button.disabled = false;
            }
        }

        function showTestResult(success, message) {
            const resultDiv = document.getElementById('testResult');
            resultDiv.className = success ? 
                'p-4 bg-green-50 border border-green-200 rounded-lg' :
                'p-4 bg-red-50 border border-red-200 rounded-lg';
            
            resultDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${success ? 'check-circle text-green-600' : 'exclamation-circle text-red-600'} mr-2"></i>
                    <span class="${success ? 'text-green-800' : 'text-red-800'}">${message}</span>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }

        function saveConfiguration() {
            // 这里应该调用后端API保存配置
            alert('配置保存功能需要后端实现');
        }

        function finishSetup() {
            alert('设置完成！您现在可以使用邮件验证功能了。');
            window.location.href = 'auth/register.html';
        }
    </script>
</body>
</html> 