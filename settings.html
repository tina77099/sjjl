<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½® - äº‹ä»¶è®°å½•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans">
    <!-- ä¾§è¾¹æ  -->
    <div class="flex h-screen overflow-hidden">
        <div class="w-64 bg-white shadow-md hidden md:block">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-indigo-600">äº‹ä»¶è®°å½•</h1>
                <p class="text-gray-500 text-sm">è®°å½•ç”Ÿæ´»ï¼Œè¿½è¸ªæˆé•¿</p>
            </div>
            <nav class="mt-6">
                <ul>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="index.html" class="flex items-center">
                            <i class="fas fa-home mr-3"></i>
                            <span>ä»ªè¡¨ç›˜</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="calendar.html" class="flex items-center">
                            <i class="fas fa-calendar-alt mr-3"></i>
                            <span>æ—¥å†è§†å›¾</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="events.html" class="flex items-center">
                            <i class="fas fa-list mr-3"></i>
                            <span>äº‹ä»¶åˆ—è¡¨</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="statistics.html" class="flex items-center">
                            <i class="fas fa-chart-pie mr-3"></i>
                            <span>ç»Ÿè®¡åˆ†æ</span>
                        </a>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="weekly_report.html" class="flex items-center">
                            <i class="fas fa-file-alt mr-3"></i>
                            <span>ä¸€å‘¨ä¸€æ‚Ÿ</span>
                        </a>
                    </li>
                    </li>
                    <li class="px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                        <a href="tags.html" class="flex items-center">
                            <i class="fas fa-tag mr-3"></i>
                            <span>æ ‡ç­¾ç®¡ç†</span>
                        </a>
                    </li>
                    <li class="px-6 py-3 bg-indigo-50 text-indigo-600 font-medium">
                        <a href="settings.html" class="flex items-center">
                            <i class="fas fa-cog mr-3"></i>
                            <span>è®¾ç½®</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="flex-1 overflow-auto">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <div id="header-container">
            <header class="bg-white shadow-sm">
                <div class="flex items-center justify-between p-4">
                    <button class="md:hidden text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold text-gray-800">è®¾ç½®</h1>
                    </div>
                    <div class="flex items-center">
                        <div class="mr-4 flex space-x-2">
                            <button id="btn-new-plan" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center">
                                <i class="fas fa-calendar-plus mr-2"></i>æ–°å»ºè®¡åˆ’
                            </button>
                            <button id="btn-new-record" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors inline-flex items-center">
                                <i class="fas fa-bookmark mr-2"></i>è®°å½•äº‹é¡¹
                            </button>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-600 font-medium">
                                <i class="fas fa-user-circle"></i>
                            </div>
                        </div>
                    </div>
                </header>
                </div>

            <!-- è®¾ç½®å†…å®¹ -->
            <main class="p-6">
                <!-- å·¦ä¾§è®¾ç½®å¯¼èˆªå’Œå³ä¾§è®¾ç½®å†…å®¹åŒºçš„å®¹å™¨ -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <!-- å·¦ä¾§è®¾ç½®å¯¼èˆª -->
                    <div class="md:col-span-3">
                        <div class="bg-white rounded-lg overflow-hidden shadow">
                            <div class="divide-y">
                                <button id="profile-btn" class="w-full py-3 px-4 text-left hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-inset setting-nav-btn active">
                                    <div class="flex items-center">
                                        <i class="fas fa-user-circle text-gray-400 w-5"></i>
                                        <span class="ml-3 text-gray-700">ä¸ªäººä¿¡æ¯</span>
                                    </div>
                                        </button>
                                <button id="about-btn" class="w-full py-3 px-4 text-left hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-inset setting-nav-btn">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-gray-400 w-5"></i>
                                        <span class="ml-3 text-gray-700">å…³äº</span>
                                    </div>
                                        </button>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§è®¾ç½®å†…å®¹åŒº -->
                    <div class="md:col-span-9">
                        <div class="space-y-6">
                            <!-- ä¸ªäººä¿¡æ¯ -->
                        <div id="profile-section" class="setting-section">
                            <div class="bg-white rounded-lg shadow overflow-hidden">
                                <div class="p-6">
                                    <h2 class="text-xl font-semibold text-gray-800 mb-6">ä¸ªäººä¿¡æ¯</h2>
                                    <form id="profile-form">
                                        <div class="mb-8">
                                            <div class="flex items-center">
                                                <div id="user-avatar-display" class="h-20 w-20 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-600 text-2xl font-medium">
                                                    <i class="fas fa-user-circle"></i>
                                                </div>
                                                <div class="ml-6">
                                                    <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                                    <button type="button" id="change-avatar-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                                        æ›´æ¢å¤´åƒ
                                                    </button>
                                                    <p class="text-sm text-gray-500 mt-1">
                                                        æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œæœ€å¤§ 5MB
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                                                <input type="text" id="username" name="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">æ˜¾ç¤ºåç§°</label>
                                                <input type="text" id="display-name" name="display_name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="è¯·è¾“å…¥æ˜¾ç¤ºåç§°">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">ç”µå­é‚®ç®±</label>
                                                <input type="email" id="user-email" name="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="è¯·è¾“å…¥é‚®ç®±" readonly>
                                                <p class="text-xs text-gray-500 mt-1">é‚®ç®±åœ°å€æ— æ³•ä¿®æ”¹</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·ç </label>
                                                <input type="tel" id="user-phone" name="phone" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " readonly>
                                                <p class="text-xs text-gray-500 mt-1">æ‰‹æœºå·ç æ— æ³•ä¿®æ”¹</p>
                                            </div>
                                        </div>
                                        <div class="mt-6">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¸ªäººç®€ä»‹</label>
                                            <textarea id="user-bio" name="bio" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" rows="3" placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§"></textarea>
                                        </div>
                                        <div class="mt-8 flex justify-end">
                                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                                ä¿å­˜æ›´æ”¹
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow overflow-hidden mt-6">
                                <div class="p-6">
                                        <h2 class="text-xl font-semibold text-gray-800 mb-6">é€€å‡ºç™»å½•</h2>
                                        <p class="text-gray-600 mb-4">é€€å‡ºå½“å‰è´¦å·çš„ç™»å½•çŠ¶æ€</p>
                                        <div class="flex justify-end">
                                            <button type="button" id="logoutBtn" data-logout-btn class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                                é€€å‡ºç™»å½•
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å…³äº -->
                        <div id="about-section" class="setting-section hidden">
                            <div class="bg-white rounded-lg shadow overflow-hidden">
                                <div class="p-6">
                                    <h2 class="text-xl font-semibold text-gray-800 mb-6">å…³äº</h2>
                                    
                                    <div class="flex items-center mb-6">
                                        <div class="h-16 w-16 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-2xl">
                                            <i class="fas fa-calendar-check"></i>
                                        </div>
                                        <div class="ml-4">
                                            <h3 class="text-lg font-medium text-gray-800">äº‹ä»¶è®°å½•</h3>
                                            <p class="text-sm text-gray-500">ç‰ˆæœ¬ 1.0.0</p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-4 mb-8">
                                            <p class="text-gray-600"><strong>1ï¸âƒ£ è¿˜åŸçœŸå®ç”Ÿæ´»çš„"æ—¶é—´ç”»åƒ"</strong></p>
                                            <p class="text-gray-600">ç”Ÿæ´»ä¸æ˜¯ä¸€åœºå®å¤§å™äº‹ï¼Œè€Œæ˜¯ç”±æ— æ•°ç»†ç¢çš„å°äº‹æ„æˆã€‚åˆ†ç±»è®°å½•ï¼Œæ­£æ˜¯å°†è¿™äº›æ—¥å¸¸å°äº‹ç³»ç»ŸåŒ–åœ°å‘ˆç°å‡ºæ¥ï¼Œè®©æˆ‘ä»¬çœ‹åˆ°æ—¶é—´çš„çœŸå®æµå‘ï¼š <br>
                                                &bull; çœ‹æ¸…å“ªäº›äº‹å¸¸åšã€å“ªäº›æ€»è¢«å¿½ç•¥ <br>
                                                &bull; ç†è§£"æˆ‘æ—¶é—´éƒ½å»å“ªå„¿äº†" <br>
                                                &bull; æ‹¿å›ç”Ÿæ´»çš„æŒæ§æƒ</p>

                                            <p class="text-gray-600"> <strong>2ï¸âƒ£ å»ºç«‹å¯¹æ—¥å¸¸çš„æ•¬æ„å’Œè¿æ¥æ„Ÿ</strong></p>
                                            <p class="text-gray-600">æˆ‘ä»¬æˆ–è®¸åšä¸äº†æƒŠå¤©åŠ¨åœ°çš„å¤§äº‹ï¼Œä½†è®¤çœŸå¯¹å¾…æ¯å¤©å‘ç”Ÿçš„å¯æ§å°äº‹ï¼Œæœ¬èº«å°±æ˜¯å¯¹ç”Ÿæ´»æœ€æ·±æƒ…çš„å›åº”ã€‚ <br>
                                                &bull; æ¯ä¸€é¡¿é¥­ã€ä¸€æ¬¡è¿åŠ¨ã€ä¸€ä¸ªé™ªä¼´éƒ½è¢«è®°å½•ï¼Œå®ƒä»¬ä¸å†é»˜é»˜æµé€ <br>
                                                &bull; è®°å½•å³å…³æ³¨ï¼Œå…³æ³¨å³å°Šé‡</p>

                                            <p class="text-gray-600"> <strong>3ï¸âƒ£ è®°å½•å³å…³æ³¨ï¼Œå…³æ³¨å³å°Šé‡</strong></p>
                                            <p class="text-gray-600">åˆ†ç±»è®°å½•æ˜¯æŠŠæ¨¡ç³Šçš„æ„¿æœ›ï¼Œåˆ†è§£ä¸ºå¯æ‰§è¡Œçš„å°æ­¥ä¼ã€‚é€šè¿‡æ¯å¤©çš„å‹¾é€‰æ‰“å¡ï¼š <br>
                                                &bull; å†…åœ¨ç›®æ ‡è¢«æ¸©æŸ”æ¨è¿› <br>
                                                &bull; ç†æƒ³ç”Ÿæ´»ä»"æƒ³ä¸€æƒ³"å˜æˆ"åšä¸€ç‚¹" <br>
                                                &bull; é¿å…"ç›²ç›®åŠªåŠ›"å’Œ"å†…è€—ç„¦è™‘"</p>

                                            <p class="text-gray-600"> <strong>4ï¸âƒ£ å¹³è¡¡å¤šé‡è§’è‰²ä¸äººç”Ÿç»´åº¦</strong></p>
                                            <p class="text-gray-600">æˆ‘ä»¬ä¸æ˜¯å•ä¸€èº«ä»½çš„äººã€‚åˆ†ç±»è®°å½•è®©æˆ‘ä»¬çœ‹åˆ°â€”â€” <br>
                                                &bull; æ˜¯å¦åé‡å·¥ä½œï¼Œå¿½ç•¥äº†å®¶åº­ï¼Ÿ <br>
                                                &bull; æ˜¯å¦é¡¾ç€æˆé•¿ï¼Œå´å¿˜äº†ä¼‘æ¯ï¼Ÿ <br>
                                                &bull; è®©"å¤šçº¿å¹¶è¡Œçš„äººç”Ÿ"æœ‰è¿¹å¯å¾ª </p>

                                            <p class="text-gray-600"> <strong>5ï¸âƒ£ å¢å¼ºæŒæ§æ„Ÿä¸æ­£å‘åé¦ˆ</strong></p>
                                                <p class="text-gray-600">æ¯å¤©å‹¾é€‰ä¸€ä¸ªä¸ªå®Œæˆé¡¹ï¼Œè·å¾—å…·è±¡æˆå°±æ„Ÿï¼Œæ˜¯æå‡å¹¸ç¦æ„Ÿæœ€ç›´æ¥çš„æ–¹å¼ä¹‹ä¸€ã€‚<br>

                                                &bull; å°äº‹å®Œæˆ â†’ æ­£å‘å¾ªç¯ â†’ ä¿¡å¿ƒæå‡ <br>
                                                &bull; æƒ…ç»ªç¨³å®šã€æ‰§è¡ŒåŠ›å¢å¼º</p>

                                            <p>è®°å½•å³å›é¡¾ï¼Œå›é¡¾å³åæ€ï¼Œåæ€å³æˆé•¿</p>
                                            
                                           
                                    </div>
                                    
                                  
                                    
                                    <div class="border-t pt-6 mb-8">
                                        <h3 class="text-lg font-medium text-gray-800 mb-4">è”ç³»æˆ‘ä»¬</h3>
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <i class="fas fa-envelope text-gray-400 w-5"></i>
                                                <span class="text-gray-600 ml-2">ziyunweier@gmail.com</span>
                                            </div>
                                           
                                        </div>
                                    </div>
                                    
                                   
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </main>
        </div>
                        </div>
                        
    <!-- é€€å‡ºç™»å½•ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
                <div class="p-6">
                <h3 class="text-xl font-medium text-gray-800 mb-4">ç¡®è®¤é€€å‡ºç™»å½•</h3>
                <p class="text-gray-600">æ‚¨ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ</p>
        <div class="mt-6 flex justify-end space-x-3">
                    <button class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50" id="cancelLogout">å–æ¶ˆ</button>
                    <button class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" id="confirmLogout">é€€å‡ºç™»å½•</button>
        </div>
    </div>
</div>
</div>

<script>
// è®¾ç½®å¯¼èˆªåˆ‡æ¢
    const settingNavBtns = document.querySelectorAll('.setting-nav-btn');
const settingSections = document.querySelectorAll('.setting-section');

    // æ˜¾ç¤ºç‰¹å®šè®¾ç½®éƒ¨åˆ†çš„å‡½æ•°
    function showSettingSection(sectionId) {
        // éšè—æ‰€æœ‰è®¾ç½®éƒ¨åˆ†
        settingSections.forEach(section => {
            section.classList.add('hidden');
        });
        
        // æ˜¾ç¤ºç›®æ ‡è®¾ç½®éƒ¨åˆ†
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.remove('hidden');
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
            settingNavBtns.forEach(btn => {
                btn.classList.remove('active');
                
                // å¦‚æœæŒ‰é’®IDä¸éƒ¨åˆ†IDç›¸åŒ¹é…ï¼ˆå»æ‰'-section'ï¼Œæ·»åŠ '-btn'ï¼‰ï¼Œåˆ™æ¿€æ´»è¯¥æŒ‰é’®
                const btnId = sectionId.replace('-section', '-btn');
                if (btn.id === btnId) {
                    btn.classList.add('active');
                }
            });
        }
    }

    // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰é”šç‚¹å¼•ç”¨
    function checkHashInURL() {
        if (window.location.hash) {
            const sectionId = window.location.hash.substring(1); // å»æ‰#ç¬¦å·
            showSettingSection(sectionId);
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URL
    window.addEventListener('load', checkHashInURL);
    
    // å½“URLçš„hashéƒ¨åˆ†å˜åŒ–æ—¶é‡æ–°æ£€æŸ¥
    window.addEventListener('hashchange', checkHashInURL);

    settingNavBtns.forEach(button => {
        button.addEventListener('click', function() {
            // è·å–ç›®æ ‡éƒ¨åˆ†ID
            const targetId = this.id.replace('-btn', '-section');
            showSettingSection(targetId);
            
            // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸åˆ·æ–°é¡µé¢
            history.pushState(null, null, '#' + targetId);
        });
    });

    // é€€å‡ºç™»å½•åŠŸèƒ½
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutModal = document.getElementById('logoutModal');
    const cancelLogout = document.getElementById('cancelLogout');
    const confirmLogout = document.getElementById('confirmLogout');

    // æ˜¾ç¤ºé€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
    logoutBtn.addEventListener('click', function() {
        logoutModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    });

    // å…³é—­é€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
    cancelLogout.addEventListener('click', function() {
        logoutModal.classList.add('hidden');
        document.body.style.overflow = '';
    });

    // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨åŒºåŸŸå…³é—­å¯¹è¯æ¡†
    logoutModal.addEventListener('click', function(e) {
        if (e.target === logoutModal) {
            logoutModal.classList.add('hidden');
            document.body.style.overflow = '';
        }
    });

    // ç¡®è®¤é€€å‡ºç™»å½•
    confirmLogout.addEventListener('click', function() {
        // æ‰§è¡Œé€€å‡ºç™»å½•æ“ä½œ
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…é™¤ä¼šè¯ã€ä»¤ç‰Œç­‰æ“ä½œ
        console.log('ç”¨æˆ·å·²é€€å‡ºç™»å½•');
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
        alert('æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•');
    
    // å…³é—­æ¨¡æ€æ¡†
        logoutModal.classList.add('hidden');
        document.body.style.overflow = '';
    
    // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        window.location.href = 'login.html';
    });

    // ç­‰å¾…authGuardåˆå§‹åŒ–å®Œæˆ
    function waitForAuthGuard() {
        let checkCount = 0;
        const maxChecks = 50; // æœ€å¤šæ£€æŸ¥50æ¬¡ï¼Œçº¦5ç§’
        
        const checkAuthGuard = () => {
            checkCount++;
            
            if (window.authGuard) {
                console.log('âœ… authGuardå·²å°±ç»ªï¼Œå¤´åƒè”åŠ¨åŠŸèƒ½å·²å¯ç”¨');
                return;
            }
            
            if (checkCount < maxChecks) {
                setTimeout(checkAuthGuard, 100);
            } else {
                console.warn('âš ï¸ authGuardæœªèƒ½åœ¨é¢„æœŸæ—¶é—´å†…åˆå§‹åŒ–ï¼Œå¤´åƒè”åŠ¨å¯èƒ½å—å½±å“');
            }
        };
        
        checkAuthGuard();
    }

    // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
    function initUserProfile() {
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        const userData = localStorage.getItem('auth_user');
        if (!userData) {
            // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
            window.location.href = 'auth/login.html';
            return;
        }

        const user = JSON.parse(userData);
        
        // å¡«å……ç”¨æˆ·ä¿¡æ¯è¡¨å•
        document.getElementById('user-email').value = user.email || '';
        document.getElementById('user-phone').value = user.phone || '';
        
        // ä»localStorageè·å–ç”¨æˆ·ä¸ªäººä¿¡æ¯
        const userProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
        document.getElementById('username').value = userProfile.username || '';
        document.getElementById('display-name').value = userProfile.display_name || user.email || user.phone || '';
        document.getElementById('user-bio').value = userProfile.bio || '';
        
        // æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
        displayUserAvatar();
        
        // è®¾ç½®å¤´åƒä¸Šä¼ åŠŸèƒ½
        setupAvatarUpload();
        
        // è®¾ç½®ä¸ªäººä¿¡æ¯ä¿å­˜åŠŸèƒ½
        setupProfileSave();
    }

    // æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
    function displayUserAvatar() {
        const avatarDisplay = document.getElementById('user-avatar-display');
        const savedAvatar = localStorage.getItem('user_avatar');
        
        if (savedAvatar) {
            avatarDisplay.innerHTML = `<img src="${savedAvatar}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full rounded-full object-cover">`;
        } else {
            avatarDisplay.innerHTML = '<i class="fas fa-user-circle"></i>';
        }
    }

    // è®¾ç½®å¤´åƒä¸Šä¼ åŠŸèƒ½
    function setupAvatarUpload() {
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const avatarUpload = document.getElementById('avatar-upload');
        
        changeAvatarBtn.addEventListener('click', function() {
            avatarUpload.click();
        });
        
        avatarUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.match(/^image\/(jpeg|png|gif)$/)) {
                alert('è¯·é€‰æ‹©JPGã€PNGæˆ–GIFæ ¼å¼çš„å›¾ç‰‡');
                return;
            }
            
            // è¯»å–æ–‡ä»¶å¹¶ä¿å­˜
            const reader = new FileReader();
            reader.onload = function(e) {
                const avatarData = e.target.result;
                localStorage.setItem('user_avatar', avatarData);
                
                // æ›´æ–°å½“å‰é¡µé¢çš„å¤´åƒæ˜¾ç¤º
                displayUserAvatar();
                
                // å¼ºåˆ¶è§¦å‘å…¨å±€å¤´åƒæ›´æ–° - å¤šé‡ä¿éšœæœºåˆ¶
                updateGlobalAvatar();
                
                alert('å¤´åƒæ›´æ–°æˆåŠŸï¼');
            };
            reader.readAsDataURL(file);
        });
    }

    // å…¨å±€å¤´åƒæ›´æ–°å‡½æ•° - ç¡®ä¿æ‰€æœ‰å¤´åƒå…ƒç´ éƒ½å¾—åˆ°æ›´æ–°
    function updateGlobalAvatar() {
        const savedAvatar = localStorage.getItem('user_avatar');
        console.log('ğŸ”„ å¼€å§‹å…¨å±€å¤´åƒæ›´æ–°ï¼Œå¤´åƒæ•°æ®:', savedAvatar ? 'å·²å­˜åœ¨' : 'æ— æ•°æ®');
        
        // æ–¹æ³•1: é€šè¿‡authGuardæ›´æ–°
        if (window.authGuard && typeof window.authGuard.getCurrentUser === 'function') {
            try {
                const user = window.authGuard.getCurrentUser();
                if (user) {
                    console.log('ğŸ“± è°ƒç”¨authGuard.updateUserDisplayæ›´æ–°å¤´åƒ');
                    window.authGuard.updateUserDisplay(user);
                    console.log('âœ… authGuardæ›´æ–°å¤´åƒæˆåŠŸ');
                } else {
                    console.warn('âš ï¸ authGuard.getCurrentUserè¿”å›ç©ºç”¨æˆ·');
                }
            } catch (error) {
                console.error('âŒ authGuardæ›´æ–°å¤±è´¥:', error);
            }
        } else {
            console.warn('âš ï¸ authGuardæœªåˆå§‹åŒ–æˆ–æ–¹æ³•ä¸å¯ç”¨');
        }
        
        // æ–¹æ³•2: ç›´æ¥æ›´æ–°DOMå…ƒç´ ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        const avatarSelectors = [
            '[data-user-avatar]',
            '#user-avatar-display',
            '.user-avatar',
            '[data-avatar]'
        ];
        
        let updateCount = 0;
        avatarSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            console.log(`ğŸ” æ‰¾åˆ° ${elements.length} ä¸ªå¤´åƒå…ƒç´ ä½¿ç”¨é€‰æ‹©å™¨: ${selector}`);
            
            elements.forEach((element, index) => {
                if (savedAvatar) {
                    element.innerHTML = `<img src="${savedAvatar}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full rounded-full object-cover">`;
                    updateCount++;
                    console.log(`âœ… æ›´æ–°å¤´åƒå…ƒç´  ${selector}[${index}]`);
                } else {
                    element.innerHTML = '<i class="fas fa-user-circle"></i>';
                    updateCount++;
                    console.log(`ğŸ”„ é‡ç½®å¤´åƒå…ƒç´  ${selector}[${index}] ä¸ºé»˜è®¤å›¾æ ‡`);
                }
            });
        });
        
        console.log(`ğŸ“Š æ€»å…±æ›´æ–°äº† ${updateCount} ä¸ªå¤´åƒå…ƒç´ `);
        
        // æ–¹æ³•3: è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç”¨äºè·¨é¡µé¢é€šçŸ¥ï¼‰
        try {
            const event = new CustomEvent('avatarUpdated', {
                detail: { 
                    avatarData: savedAvatar,
                    timestamp: Date.now()
                }
            });
            window.dispatchEvent(event);
            console.log('âœ… è§¦å‘å¤´åƒæ›´æ–°äº‹ä»¶ (avatarUpdated)');
        } catch (error) {
            console.error('âŒ è‡ªå®šä¹‰äº‹ä»¶è§¦å‘å¤±è´¥:', error);
        }
        
        // æ–¹æ³•4: æ‰‹åŠ¨è§¦å‘storageäº‹ä»¶ï¼ˆç”¨äºåŒæ ‡ç­¾é¡µé€šçŸ¥ï¼‰
        try {
            const storageEvent = new StorageEvent('storage', {
                key: 'user_avatar',
                newValue: savedAvatar,
                oldValue: null,
                url: window.location.href,
                storageArea: localStorage
            });
            window.dispatchEvent(storageEvent);
            console.log('âœ… è§¦å‘storageäº‹ä»¶');
        } catch (error) {
            console.error('âŒ storageäº‹ä»¶è§¦å‘å¤±è´¥:', error);
        }
        
        // æ–¹æ³•5: å»¶è¿Ÿé‡è¯•æœºåˆ¶ï¼ˆç¡®ä¿å…¶ä»–é¡µé¢æœ‰æ—¶é—´å“åº”ï¼‰
        setTimeout(() => {
            if (window.authGuard && typeof window.authGuard.updateUserDisplay === 'function') {
                try {
                    const user = window.authGuard.getCurrentUser();
                    if (user) {
                        window.authGuard.updateUserDisplay(user);
                        console.log('ğŸ”„ å»¶è¿Ÿé‡è¯•ï¼šauthGuardå¤´åƒæ›´æ–°æˆåŠŸ');
                    }
                } catch (error) {
                    console.error('âŒ å»¶è¿Ÿé‡è¯•å¤±è´¥:', error);
                }
            }
        }, 500);
        
        // æ–¹æ³•6: é€šçŸ¥å…¶ä»–çª—å£/æ ‡ç­¾é¡µï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        try {
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('avatar_update');
                channel.postMessage({
                    type: 'AVATAR_UPDATED',
                    avatarData: savedAvatar,
                    timestamp: Date.now()
                });
                channel.close();
                console.log('ğŸ“¡ é€šè¿‡BroadcastChannelé€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µ');
            }
        } catch (error) {
            console.error('âŒ BroadcastChannelé€šçŸ¥å¤±è´¥:', error);
        }
    }

    // è®¾ç½®ä¸ªäººä¿¡æ¯ä¿å­˜åŠŸèƒ½
    function setupProfileSave() {
        const profileForm = document.getElementById('profile-form');
        
        profileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(profileForm);
            const profileData = {
                username: formData.get('username'),
                display_name: formData.get('display_name'),
                bio: formData.get('bio'),
                updated_at: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('user_profile', JSON.stringify(profileData));
            
            // æ›´æ–°å…¨å±€ç”¨æˆ·æ˜¾ç¤º
            if (window.authGuard) {
                const user = window.authGuard.getCurrentUser();
                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ä¸­çš„æ˜¾ç¤ºåç§°
                if (profileData.display_name) {
                    user.display_name = profileData.display_name;
                    localStorage.setItem('auth_user', JSON.stringify(user));
                }
                window.authGuard.updateUserDisplay(user);
            }
            
            alert('ä¸ªäººä¿¡æ¯ä¿å­˜æˆåŠŸï¼');
        });
    }
</script>

<!-- å¼¹å‡ºçª—å£ - æ–°å»ºè®¡åˆ’ -->
<div id="modal-new-plan" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-2xl font-bold text-gray-800">æ–°å»ºè®¡åˆ’</h2>
            <button id="close-plan-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="new-plan-form">
                <!-- è®¡åˆ’æ ‡é¢˜ -->
                <div class="mb-4">
                    <label for="plan-title" class="block text-gray-700 font-medium mb-2">è®¡åˆ’æ ‡é¢˜</label>
                    <input type="text" id="plan-title" name="title" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" 
                        placeholder="è¾“å…¥è®¡åˆ’åç§°" required>
                </div>

                <!-- è®¡åˆ’ç±»å‹ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">è®¡åˆ’ç±»å‹</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-work" class="mr-2" value="work" checked>
                            <label for="type-work" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                å·¥ä½œèŒä¸š
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-study" class="mr-2" value="study">
                            <label for="type-study" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                å­¦ä¹ æˆé•¿
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-exp" class="mr-2" value="experience">
                            <label for="type-exp" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                                ä½“éªŒçªç ´
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-leisure" class="mr-2" value="leisure">
                            <label for="type-leisure" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                ä¼‘é—²æ”¾æ¾
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-family" class="mr-2" value="family">
                            <label for="type-family" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                å®¶åº­ç”Ÿæ´»
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer plan-type-option">
                            <input type="radio" name="plan-type" id="type-social" class="mr-2" value="social">
                            <label for="type-social" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></span>
                                äººé™…ç¤¾ç¾¤
                            </label>
                        </div>
                    </div>
                </div>

                <!-- è®¡åˆ’æè¿° -->
                <div class="mb-4">
                    <label for="plan-desc" class="block text-gray-700 font-medium mb-2">è®¡åˆ’è¯¦æƒ…æè¿°</label>
                    <textarea id="plan-desc" name="description" rows="3" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" 
                        placeholder="è¾“å…¥è®¡åˆ’çš„è¯¦ç»†æè¿°"></textarea>
                </div>

                <!-- æˆªæ­¢æ—¥æœŸ -->
                <div class="mb-4">
                    <label for="plan-due-date" class="block text-gray-700 font-medium mb-2">æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="plan-due-date" name="due-date" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" required>
                </div>

                <!-- ä¼˜å…ˆçº§ -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">ä¼˜å…ˆçº§</label>
                    <div class="flex space-x-4">
                        <div class="flex items-center">
                            <input type="radio" name="priority" id="priority-low" class="mr-2" value="low">
                            <label for="priority-low" class="text-green-600">ä½</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="priority" id="priority-medium" class="mr-2" value="medium" checked>
                            <label for="priority-medium" class="text-yellow-600">ä¸­</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="priority" id="priority-high" class="mr-2" value="high">
                            <label for="priority-high" class="text-red-600">é«˜</label>
                        </div>
                    </div>
                </div>
                
                <!-- æŒ‰é’® -->
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-plan-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ä¿å­˜è®¡åˆ’
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- å¼¹å‡ºçª—å£ - è®°å½•äº‹é¡¹ -->
<div id="modal-new-record" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-2xl font-bold text-gray-800">è®°å½•äº‹é¡¹</h2>
            <button id="close-record-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="new-record-form">
                <!-- äº‹é¡¹æ ‡é¢˜ -->
                <div class="mb-4">
                    <label for="record-title" class="block text-gray-700 font-medium mb-2">äº‹é¡¹æ ‡é¢˜</label>
                    <input type="text" id="record-title" name="title" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" 
                        placeholder="è¾“å…¥äº‹é¡¹åç§°" required>
                </div>

                <!-- äº‹é¡¹åˆ†ç±» -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">äº‹é¡¹åˆ†ç±»</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-study" class="mr-2" value="study" checked>
                            <label for="rec-type-study" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                å­¦ä¹ æˆé•¿
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-exp" class="mr-2" value="experience">
                            <label for="rec-type-exp" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                                ä½“éªŒçªç ´
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-leisure" class="mr-2" value="leisure">
                            <label for="rec-type-leisure" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                ä¼‘é—²æ”¾æ¾
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-family" class="mr-2" value="family">
                            <label for="rec-type-family" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                å®¶åº­ç”Ÿæ´»
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-work" class="mr-2" value="work">
                            <label for="rec-type-work" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                å·¥ä½œèŒä¸š
                            </label>
                        </div>
                        <div class="flex items-center p-3 border rounded-lg hover:bg-purple-50 cursor-pointer record-type-option">
                            <input type="radio" name="record-type" id="rec-type-social" class="mr-2" value="social">
                            <label for="rec-type-social" class="flex items-center cursor-pointer">
                                <span class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></span>
                                äººé™…ç¤¾ç¾¤
                            </label>
                        </div>
                    </div>
                </div>

                <!-- å®Œæˆæ—¥æœŸå’Œæ—¶é—´ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">å®Œæˆæ—¥æœŸå’Œæ—¶é—´</label>
                    <div class="flex space-x-2">
                        <input type="date" id="record-date" name="completion-date" 
                            class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" required>
                        <input type="time" id="record-time" name="completion-time" 
                            class="w-32 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" required>
                    </div>
                </div>

                <!-- äº‹é¡¹è¯¦æƒ… -->
                <div class="mb-4">
                    <label for="record-desc" class="block text-gray-700 font-medium mb-2">äº‹é¡¹è¯¦æƒ…</label>
                    <textarea id="record-desc" name="description" rows="3" 
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" 
                        placeholder="è¾“å…¥äº‹é¡¹çš„è¯¦ç»†æè¿°æˆ–æ„Ÿæƒ³"></textarea>
                </div>
                
                <!-- æŒ‰é’® -->
                <div class="flex justify-end space-x-3">
                    <button type="button" id="delete-record-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hidden">
                        åˆ é™¤
                    </button>
                    <button type="button" id="cancel-record-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" id="submit-record-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        ä¿å­˜è®°å½•
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="js/common.js"></script>
<script src="js/auth-system.js"></script>
<script src="js/auth-guard.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        initUserProfile();
        
        // ç­‰å¾…authGuardåˆå§‹åŒ–å®Œæˆ
        waitForAuthGuard();
        
        // å¼¹å‡ºçª—å£åŠŸèƒ½
        const planModal = document.getElementById('modal-new-plan');
        const recordModal = document.getElementById('modal-new-record');
        
        // æ‰“å¼€å¼¹å‡ºçª—å£
        document.getElementById('btn-new-plan').addEventListener('click', function() {
            planModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        });
        
        document.getElementById('btn-new-record').addEventListener('click', function() {
            recordModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });
        
        // å…³é—­å¼¹å‡ºçª—å£
        document.getElementById('close-plan-modal').addEventListener('click', function() {
            planModal.classList.add('hidden');
            document.body.style.overflow = '';
        });
        
        document.getElementById('cancel-plan-btn').addEventListener('click', function() {
            planModal.classList.add('hidden');
            document.body.style.overflow = '';
        });
        
        document.getElementById('close-record-modal').addEventListener('click', function() {
            recordModal.classList.add('hidden');
            document.body.style.overflow = '';
        });
        
        document.getElementById('cancel-record-btn').addEventListener('click', function() {
            recordModal.classList.add('hidden');
            document.body.style.overflow = '';
        });
        
        // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
        planModal.addEventListener('click', function(e) {
            if (e.target === planModal) {
                planModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });
        
        recordModal.addEventListener('click', function(e) {
            if (e.target === recordModal) {
                recordModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });
        
        // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
        const today = new Date();
        const formattedDate = today.toISOString().substring(0, 10);
        document.getElementById('plan-due-date').value = formattedDate;
        document.getElementById('record-date').value = formattedDate;
        
        // ç¡®ä¿è¡¨å•å¤„ç†ç¨‹åºåˆå§‹åŒ–
        if (typeof initializeFormHandlers === 'function') {
            initializeFormHandlers();
            console.log('å·²åˆå§‹åŒ–è¡¨å•å¤„ç†ç¨‹åº');
        } else {
            console.error('æœªæ‰¾åˆ°initializeFormHandlerså‡½æ•°');
        }
    });
</script>
</body>
</html>
